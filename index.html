<!DOCTYPE html>
<html>
<meta charset="utf-8">
<base href="/">
 <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
 <link rel="stylesheet" href="css/style.css"/>
 <link rel="stylesheet" href="css/drawer.css"/>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://d3js.org/d3-queue.v3.min.js"></script>
<script src="https://d3js.org/d3-hierarchy.v1.min.js"></script>
<script src="js/micro-templating.js"></script>
<script src="js/servicesVsGroups.js"></script>

<style>
  
.node {
  stroke: initial
}
.node circle {
  cursor: pointer;
  fill: #fff;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.node text {
  font-size: 11px;
}

path.link {
  fill: none;
  stroke: #ccc;
  stroke-width: 1.5px;
} 
 

 .svg-container {
    display: inline-block;
    position: relative;
    width: 100%;
    /* padding-bottom: 100%; */
    vertical-align: top;
    /* overflow: hidden; */
}
.svg-content {
    display: inline-block;
    /* position: absolute; */
    top: 0;
    left: 0;
}  

    </style>
</style>

<body>
    <script type="text/html" id="service_linking_drawer">
      <div class="section">
        <div class="section-title">
          <h3>Service direct input/output flow</h3>
        </div>

        <ul>
            <% if (servicesIO.input && servicesIO.input.length >0 ) { %>
              <% for (var i =0; i < servicesIO.input.length; i++) { %>
                <li class="input"><span><%=servicesIO.input[i]%></span></li>
              <% } %>        
              
              <li class="arrow-down"><img src="img/arrow-down.png" class="img-arrow-down"/></li>
              <li class="input title"><span>Input</span></li>
            <% } %>
    
            <li class="main-service">
              <span><%=name%></span>
            </li>
    
            <% if (servicesIO.output && servicesIO.output.length >0 ) { %>
              <li class="output title"><span>Output</span></li>
              <li class="arrow-down"><img src="img/arrow-down.png" class="img-arrow-down"/></li>
            
              <% for (var i =0; i < servicesIO.output.length; i++) { %>
                <li class="output"><span><%=servicesIO.output[i]%></span></li>
              <% } %>
            <% } %>
        </ul>  
      </div>
    </script>

    <script type='text/html' id='service_node_popover'>
      <div>
        <ul class="list-unstyled">
          <li><a href="<%=url%>" target="_blank">Official docs</a></li>
          <% if (servicesIO.input && servicesIO.input.length >0
          || servicesIO.output && servicesIO.output.length >0 ) { %>
            <li>
              <a href="#" 
                data-toggle="modal"  
                data-target="#direct-io-out-services-modal"  
                data-service-id="<%=id%>" 
                > 
                Show Direct In/Out connections 
              </a></li>          
          </ul>
          <% } %>
      </div>
    </script>

    <script type='text/html' id="direct_io_out_services_modal_tpl">
      <div class="container">
        <div class="row">
          <% if (servicesIO.input && servicesIO.input.length >0 ) { %>
            <div class="col">
              <div class="list-group">
                <div class="list-group-item list-group-item-action bg-primary listIOtitle text-center text-bold">
                  To: <%=name%><br/>
                  <img src="/img/arrow-down.png" width="35px" style="transform: rotate(180deg);">
                </div>
                
                  <% for (var i =0; i < servicesIO.input.length; i++) { %>
                    <span class="list-group-item list-group-item-action">
                        <% if (SL.services[servicesIO.input[i]]) { %>
                          <%=SL.services[servicesIO.input[i]].name%>
                        <% } else { %>  
                          <%=servicesIO.input[i]%>
                        <% } %> 
                    </span>
                  <% } %>                                    
                </div>
            </div>          
          <% } %>

          <% if (servicesIO.output && servicesIO.output.length >0 ) { %>
            <div class="col">
              <div class="list-group">
                  <div class="list-group-item list-group-item-action bg-success listIOtitle text-center text-bold">
                      From: <%=name%><br/>
                      <img src="/img/arrow-down.png" width="35px">
                    </div>
                
                  <% for (var i =0; i < servicesIO.output.length; i++) { %>
                    <span class="list-group-item list-group-item-action">
                      <% if (SL.services[servicesIO.output[i]]) { %>
                        <%=SL.services[servicesIO.output[i]].name%>
                      <% } else { %>  
                        <%=servicesIO.output[i]%>
                      <% } %>  
                    </span>
                  <% } %>
              </div>
            </div>
          <% } %>
        </div>        
      </div>
    </script>

    <div class="modal" id="direct-io-out-services-modal" tabindex="-1" aria-labelledby="direct-io-out-services-modal" role="dialog"  aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalScrollableTitle">Service direct input/output connections </h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
              </div>
              <div class="modal-body">
              </div>              
          </div>
      </div>      
    </div>




    <div class="container-fluid">
        <div class="text-center">
          <div class="github-link">
              <h3>
                  <a href="https://github.com/nnmer/azure-services-map">
                      <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" width="40px">
                  </a>
              </h3>
          </div>
          <div class="page-caption">
            <div>
              <h2>Reference to Azure services</h2>
              <span>
                  Doubleclick on a node to focus. Drag to better location.
              </span>            
            </div>            
          </div>   
        </div>
        <div>
            <div class="node-notes pull-right">
                <dl class="dl-horizontal" >
                  <dt><svg width="20" height="20">
                      <circle cx="10" cy="10" class="node"></circle>
                      <!-- <text x="10" y="10">- Service has input/output connections</text> -->
                    </svg></dt>
                  <dd>
                    &nbsp;- azure service
                  </dd>
  
                  <dt><svg width="20" height="20">
                      <circle cx="10" cy="10" class="node has-linking-services"></circle>
                      <!-- <text x="10" y="10">- Service has input/output connections</text> -->
                    </svg></dt>
                  <dd>
                    &nbsp;- a service with input/output connections
                  </dd>
  
                  <dt><svg width="20" height="20">
                      <circle cx="10" cy="10" class="node node-category" style="r: 10"></circle>
                      <!-- <text x="10" y="10">- Service has input/output connections</text> -->
                    </svg></dt>
                  <dd>
                    &nbsp;- a service category
                  </dd>
                </dl>                    
              </div>       
        </div>
        
        <div class="clearfix"></div>
    </div>
    <div>
        <input type="checkbox" id="drawer-toggle">
        <label for="drawer-toggle" id="drawer-toggle-label"></label>

        <nav id="drawer"></nav>

        <div class="svg-container">
          <div id="service-flow"></div>
          <div id="service-vs-group-map" ></div>
        </div>

        <script>
            var SL = null;
            d3.queue()
              .defer(d3.json, "js/data/azure-services.json")
              .defer(d3.json, "js/data/azure-services-linking.json")
              .await(start);

            function start(error, services, serviceLinking) {
              if(error) {
                alert('Cannot get data')
                return false 
              }

              SL = new ServiceLinking(services, serviceLinking)            
              servicesVsGroupsForceDirectedTree(SL.services)
            }      
            
            function showServiceLinkingDrawer(serviceId, services) {
              let drawer = document.getElementById("drawer");
              let toggle = document.getElementById("drawer-toggle")
              if (false === serviceId) { 
                toggle.removeAttribute('checked')                
                document.getElementById("service-flow").innerHTML = '';
                return;
              }
              if (services[serviceId].hasLinkingServices ) {
                toggle.setAttribute('checked','checked')
                drawer.innerHTML = tmpl("service_linking_drawer", services[serviceId]);
                showServiceIntegrationTree(serviceId, services)
                // t = d3.select("#service-flow").select("svg")
                // x = t.node().getBoundingClientRect();
                // y = t.node().getBBox()
                // //t.attr("width", x.width + y.width)
                // t.attr("viewBox", "0 0 "+x.width +" "+ x.height)
                // console.warn(t,x,y)
              }
            }

            function showServiceIntegrationTree(serviceId, services) {
              function buildChildren(id) {
                // console.warn('Called buildChildren',id)
                let service = services[id];
                let obj = {
                  name: service ? service.name : id
                }
                circularRefTrack.push(id)

                if (service && service.servicesIO.output.length > 0){
                  for (let i=0;i<service.servicesIO.output.length;i++){
                    let servId = service.servicesIO.output[i];
                      // console.warn(i)
                      // console.warn(servId)
                      // console.warn(services[servId])
                      // console.warn(circularRefTrack)
                      let depService = services[servId]
                    let toInject = null;
                    if (circularRefTrack.indexOf(servId) === -1 && depService) {
                      toInject = buildChildren(servId)
                    } else {
                      toInject = {
                        name: depService ? depService.name : servId
                      }
                      circularRefTrack.push(servId)
                    }
                    if (!obj.children){
                      obj.children = []
                    }
                    obj.children.push(toInject)                    
                  }
                }

                return obj;
              }

              var circularRefTrack = [];
              let tree = buildChildren(serviceId)              
              serviceFlowTree(tree)                            
            }
            
        </script>
    </div>



  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  <script>
    $(document).ready(function(){      
      $('body').click( function(e){
        if (!$(e.target).is("circle[id^=service-node]")) {
          $('circle[id^=service-node]').popover('hide')
          }
      });
      
      $('#direct-io-out-services-modal').on('shown.bs.modal', function (event) {
        var button = $(event.relatedTarget)
        var serviceId = button.data('serviceId')         
        var modal = $(this)
      
        modal.find('.modal-body').html(
          tmpl("direct_io_out_services_modal_tpl", SL.services[serviceId])
        )    
      })
    })
  </script>
</body>
</html>